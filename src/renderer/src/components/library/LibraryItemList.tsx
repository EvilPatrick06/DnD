import { useVirtualizer } from '@tanstack/react-virtual'
import { useRef } from 'react'
import type { LibraryItem } from '../../types/library'
import { getCategoryDef } from '../../types/library'

interface LibraryItemListProps {
  items: LibraryItem[]
  loading: boolean
  onSelectItem: (item: LibraryItem) => void
  onCreateNew: () => void
  categoryLabel: string
}

export default function LibraryItemList({
  items,
  loading,
  onSelectItem,
  onCreateNew,
  categoryLabel
}: LibraryItemListProps): JSX.Element {
  const parentRef = useRef<HTMLDivElement>(null)

  const virtualizer = useVirtualizer({
    count: items.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 72,
    overscan: 10
  })

  if (loading) {
    return (
      <div className="flex items-center justify-center py-20">
        <div className="flex items-center gap-3 text-gray-400">
          <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
          </svg>
          <span>Loading {categoryLabel}...</span>
        </div>
      </div>
    )
  }

  if (items.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-20 text-gray-500">
        <svg
          className="w-12 h-12 mb-3 text-gray-600"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          strokeWidth={1.5}
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
          />
        </svg>
        <p className="text-lg mb-1">No items found</p>
        <p className="text-sm mb-4">Try adjusting your search or filters</p>
        <button
          onClick={onCreateNew}
          className="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold transition-colors cursor-pointer"
        >
          Create Custom {categoryLabel}
        </button>
      </div>
    )
  }

  return (
    <div ref={parentRef} className="flex-1 overflow-y-auto">
      <div style={{ height: `${virtualizer.getTotalSize()}px`, width: '100%', position: 'relative' }}>
        {virtualizer.getVirtualItems().map((virtualRow) => {
          const item = items[virtualRow.index]
          const catDef = getCategoryDef(item.category)
          return (
            <div
              key={virtualRow.key}
              data-index={virtualRow.index}
              ref={virtualizer.measureElement}
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                transform: `translateY(${virtualRow.start}px)`
              }}
            >
              <button
                onClick={() => onSelectItem(item)}
                className="w-full text-left flex items-center gap-3 px-4 py-3 border-b border-gray-800/50
                  hover:bg-gray-800/40 transition-colors cursor-pointer group"
              >
                {catDef && <span className="text-lg leading-none flex-shrink-0">{catDef.icon}</span>}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium text-gray-100 group-hover:text-amber-400 transition-colors truncate">
                      {item.name}
                    </span>
                    {item.source === 'homebrew' && (
                      <span className="text-[10px] bg-purple-600/30 text-purple-300 px-1.5 py-0.5 rounded-full flex-shrink-0">
                        Homebrew
                      </span>
                    )}
                  </div>
                  <p className="text-xs text-gray-500 truncate mt-0.5">{item.summary}</p>
                </div>
                <svg
                  className="w-4 h-4 text-gray-600 group-hover:text-gray-400 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  strokeWidth={2}
                >
                  <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>
          )
        })}
      </div>
    </div>
  )
}
