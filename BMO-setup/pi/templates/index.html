<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BMO</title>
  <script src="/static/js/tailwind.js"></script>
  <script src="/static/js/socket.io.min.js"></script>
  <script defer src="/static/js/alpine.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            surface: { DEFAULT: '#111827', light: '#1f2937', dark: '#030712' },
            accent: { DEFAULT: '#d97706', light: '#f59e0b', dim: '#92400e' },
            text: { DEFAULT: '#f3f4f6', muted: '#9ca3af', dim: '#6b7280' }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/static/css/bmo.css">
</head>
<body class="bg-surface-dark text-text overflow-hidden select-none flex flex-col h-screen" x-data="bmo()" x-init="init()">

  <!-- Top Bar -->
  <header class="h-10 shrink-0 bg-surface flex items-center justify-between px-3 text-sm border-b border-surface-light z-10 relative"
          @click="tab = 'calendar'">
    <div class="flex items-center gap-3">
      <span x-text="clock" class="font-mono text-accent-light"></span>
      <span x-text="dateStr" class="text-text-muted"></span>
    </div>
    <div class="flex items-center gap-3">
      <span x-show="weather.temperature !== null" class="text-text-muted">
        <span x-text="weather.temperature + '°F'"></span>
        <span x-text="weatherIcon(weather.icon)" class="ml-1"></span>
      </span>
      <!-- Notification bell -->
      <div class="relative" @click.stop="showNotifications = !showNotifications; unreadNotifications = 0">
        <span class="text-text-muted cursor-pointer text-sm">&#x1F514;</span>
        <span x-show="unreadNotifications > 0"
              class="absolute -top-1 -right-1 bg-accent text-surface-dark text-[8px] font-bold rounded-full w-3.5 h-3.5 flex items-center justify-center"
              x-text="unreadNotifications"></span>
      </div>
      <span class="w-2 h-2 rounded-full" :class="statusColor"></span>
    </div>
  </header>
  <!-- Notification History Dropdown -->
  <div x-show="showNotifications" @click.away="showNotifications = false"
       class="absolute top-10 right-2 w-64 bg-surface border border-surface-light rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto">
    <template x-for="(n, i) in notificationHistory" :key="i">
      <div class="px-3 py-2 border-b border-surface-light last:border-0 text-xs">
        <span x-text="n.text"></span>
        <span class="text-text-dim ml-1" x-text="n.time"></span>
      </div>
    </template>
    <div x-show="notificationHistory.length === 0" class="px-3 py-4 text-xs text-text-dim text-center">No notifications</div>
  </div>

  <!-- Content Area -->
  <main class="flex-1 overflow-hidden min-h-0 relative">

    <!-- Home Tab — Dashboard -->
    <div x-show="tab === 'home'"
         :class="swipeDirection === 'left' ? 'tab-slide-enter-left' : swipeDirection === 'right' ? 'tab-slide-enter-right' : ''"
         class="h-full overflow-y-auto p-3 space-y-2">
      <!-- Clock row + status -->
      <div class="flex items-baseline justify-between">
        <div class="flex items-baseline gap-3">
          <span class="text-3xl font-mono text-accent-light" x-text="clock"></span>
          <span class="text-sm text-text-muted" x-text="fullDateStr"></span>
        </div>
        <span class="text-xs pr-16" :class="statusTextColor" x-text="statusText"></span>
      </div>
      <!-- Weather card -->
      <div x-show="weather.temperature !== null" class="bg-surface-light rounded-lg px-3 py-2">
        <div class="flex items-center gap-2">
          <span x-text="weatherIcon(weather.icon)" class="text-2xl"></span>
          <div>
            <div class="text-lg font-medium">
              <span x-text="weather.temperature + '°F'"></span>
              <span class="text-sm text-text-muted ml-1" x-text="weather.description"></span>
            </div>
            <div x-show="weatherSuggestion" class="text-xs text-accent" x-text="weatherSuggestion"></div>
          </div>
        </div>
        <!-- 3-day forecast -->
        <div x-show="weather.forecast && weather.forecast.length" class="flex gap-2 mt-2 justify-center">
          <template x-for="(day, i) in (weather.forecast || [])" :key="i">
            <div class="flex flex-col items-center text-xs text-text-muted">
              <span x-text="new Date(day.date + 'T12:00:00').toLocaleDateString('en-US', {weekday:'short'})"></span>
              <span x-text="weatherIcon(day.icon)"></span>
              <span><span class="text-text" x-text="day.high + '°'"></span> <span x-text="day.low + '°'"></span></span>
            </div>
          </template>
        </div>
      </div>
      <!-- Next Events card -->
      <div x-show="calEvents.length > 0" class="bg-surface-light rounded-lg px-3 py-2">
        <div class="text-[10px] text-text-dim uppercase tracking-wider mb-1">Upcoming</div>
        <template x-for="(event, i) in calEvents.slice(0, 3)" :key="event.id || i">
          <div class="flex items-center gap-2 py-0.5 cursor-pointer" @click="tab = 'calendar'">
            <div class="w-1 h-6 bg-accent rounded-full shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium truncate" x-text="event.summary"></div>
              <div class="text-[10px] text-text-muted truncate" x-text="event.start"></div>
            </div>
          </div>
        </template>
      </div>
      <!-- Now Playing card -->
      <div x-show="musicState.song" class="bg-surface-light rounded-lg px-3 py-2 flex items-center gap-2 cursor-pointer" @click="tab = 'music'">
        <img :src="musicState.song?.thumbnail" class="w-10 h-10 rounded object-cover shrink-0" x-show="musicState.song?.thumbnail">
        <div class="flex-1 min-w-0">
          <div class="text-[10px] text-text-dim uppercase tracking-wider">Now Playing</div>
          <div class="text-xs font-medium truncate" x-text="musicState.song?.title"></div>
          <div class="text-[10px] text-text-muted truncate" x-text="musicState.song?.artist"></div>
        </div>
        <button @click.stop="musicCmd('pause')" class="w-8 h-8 flex items-center justify-center rounded-full bg-accent text-surface-dark shrink-0">
          <template x-if="musicState.is_playing">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>
            </svg>
          </template>
          <template x-if="!musicState.is_playing">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
          </template>
        </button>
      </div>
      <!-- Notes widget -->
      <div class="bg-surface-light rounded-lg px-3 py-2">
        <div class="text-[10px] text-text-dim uppercase tracking-wider mb-1">Notes</div>
        <form @submit.prevent="addNote()" class="flex gap-1 mb-1">
          <input x-model="newNoteText" type="text" placeholder="Add a note..."
                 class="flex-1 bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
          <button type="submit" class="bg-accent text-surface-dark px-2 py-1 rounded text-xs font-medium">+</button>
        </form>
        <div class="max-h-24 overflow-y-auto space-y-0.5">
          <template x-for="note in notes" :key="note.id">
            <div class="flex items-center gap-1.5 group">
              <button @click="toggleNote(note)" class="w-4 h-4 shrink-0 rounded border flex items-center justify-center text-[10px]"
                      :class="note.done ? 'bg-accent border-accent text-surface-dark' : 'border-text-dim'">
                <span x-show="note.done">&#10003;</span>
              </button>
              <span class="flex-1 text-xs truncate" :class="note.done ? 'line-through text-text-dim' : ''" x-text="note.text"></span>
              <button @click="deleteNote(note.id)" class="text-[10px] text-red-400 opacity-0 group-hover:opacity-100 px-1">&times;</button>
            </div>
          </template>
        </div>
      </div>
      <!-- Active timers badge -->
      <div x-show="activeTimerCount > 0" @click="tab = 'timers'"
           class="bg-surface-light rounded-lg px-3 py-2 flex items-center gap-2 cursor-pointer hover:bg-accent/10 transition-colors">
        <span class="text-lg">&#x23F1;</span>
        <span class="text-xs text-text-muted" x-text="activeTimerCount + ' timer' + (activeTimerCount !== 1 ? 's' : '') + ' running'"></span>
      </div>
    </div>

    <!-- Chat Tab -->
    <div x-show="tab === 'chat'"
         :class="swipeDirection === 'left' ? 'tab-slide-enter-left' : swipeDirection === 'right' ? 'tab-slide-enter-right' : ''"
         class="h-full flex flex-col">

      <!-- Agent indicator bar -->
      <div x-show="agentUsed && agentUsed !== 'conversation'" class="px-3 py-1 bg-surface-light/50 border-b border-surface-light flex items-center gap-2 text-xs text-text-dim">
        <span class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></span>
        <span x-text="agentDisplayName || agentUsed"></span>
      </div>

      <!-- Plan mode panel (collapsible, shows above chat when in plan mode) -->
      <div x-show="planMode" class="border-b border-accent-dim bg-surface-dark/60">
        <!-- Plan status bar -->
        <div class="px-3 py-1.5 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-xs font-medium text-accent"
                  x-text="planStatus === 'exploring' ? 'Exploring...' : planStatus === 'designing' ? 'Designing...' : planStatus === 'review' ? 'Plan Ready' : planStatus === 'executing' ? 'Executing...' : 'Plan Mode'"></span>
            <span x-show="planStatus === 'executing'" class="text-xs text-text-dim"
                  x-text="planCurrentStep + '/' + planTotalSteps"></span>
          </div>
          <div x-show="planStatus === 'review'" class="flex gap-1">
            <button @click="approvePlan()" class="px-2 py-0.5 rounded text-xs bg-green-600 text-white hover:bg-green-500">Approve</button>
            <button @click="rejectPlan()" class="px-2 py-0.5 rounded text-xs bg-red-600/80 text-white hover:bg-red-500">Cancel</button>
          </div>
        </div>
        <!-- Plan steps (collapsed by default, expandable) -->
        <div x-show="planSteps.length > 0" class="px-3 pb-2 space-y-0.5 max-h-32 overflow-y-auto">
          <template x-for="step in planSteps" :key="step.num">
            <div class="flex items-center gap-1.5 text-xs" :class="step.status === 'done' ? 'text-green-400' : step.status === 'running' ? 'text-accent' : step.status === 'failed' ? 'text-red-400' : 'text-text-dim'">
              <span x-text="step.status === 'done' ? '\u2713' : step.status === 'running' ? '\u25B6' : step.status === 'failed' ? '\u2717' : '\u25CB'"></span>
              <span x-text="step.num + '. ' + step.desc" class="truncate"></span>
              <span class="text-[10px] opacity-60" x-text="step.agent"></span>
            </div>
          </template>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-3 space-y-2" id="chatScroll" x-ref="chatScroll">
        <template x-for="(msg, i) in messages" :key="i">
          <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
            <div class="max-w-[75%] rounded-xl px-3 py-2 text-sm"
                 :class="msg.role === 'user' ? 'bg-accent text-surface-dark' : (msg.isRecap ? 'bg-accent-dim/30 text-accent-light italic border border-accent-dim' : 'bg-surface-light text-text')">
              <div x-show="msg.speaker && msg.role === 'user'" class="text-xs opacity-70 mb-0.5" x-text="msg.speaker"></div>
              <div x-text="msg.text"></div>
            </div>
          </div>
        </template>
        <div x-show="status === 'thinking' || status === 'yapping'" class="flex justify-start">
          <div class="bg-surface-light rounded-xl px-3 py-2 text-sm text-text-muted animate-pulse" x-text="status === 'yapping' ? 'BMO is yapping!' : 'BMO is thinking!'"></div>
        </div>
      </div>
      <!-- Player Selector (D&D mode) -->
      <div x-show="players.length > 0" class="px-2 pt-1 border-t border-surface-light flex items-center gap-1 overflow-x-auto">
        <span class="text-[10px] text-text-dim shrink-0">Speaking as:</span>
        <template x-for="p in players" :key="p">
          <button @click="activePlayer = p"
                  class="px-2 py-0.5 rounded-full text-[11px] font-medium transition-colors shrink-0"
                  :class="activePlayer === p ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted hover:bg-surface'">
            <span x-text="p"></span>
          </button>
        </template>
      </div>
      <form @submit.prevent="sendChat()" class="p-2 border-t border-surface-light flex gap-2"
            :class="players.length > 0 ? 'pt-1' : ''">
        <input x-model="chatInput" type="text" :placeholder="activePlayer ? (activePlayer + ': What do you do?') : statusText"
               class="flex-1 bg-surface-light rounded-lg px-3 py-2 text-sm text-text outline-none focus:ring-1 focus:ring-accent">
        <button type="button" @click="showCameraOverlay = true"
                class="bg-surface-light hover:bg-accent/20 text-text-muted px-3 py-2 rounded-lg text-sm">&#x1F4F7;</button>
        <button type="submit" class="bg-accent hover:bg-accent-light text-surface-dark px-4 py-2 rounded-lg text-sm font-medium">Send</button>
      </form>
    </div>

    <!-- Music Tab -->
    <div x-show="tab === 'music'"
         :class="swipeDirection === 'left' ? 'tab-slide-enter-left' : swipeDirection === 'right' ? 'tab-slide-enter-right' : ''"
         class="h-full flex flex-col p-3 gap-2">
      <!-- Search -->
      <form @submit.prevent="searchMusic()" class="flex gap-2">
        <input x-model="musicQuery" @input="searchMusicDebounced()" @focus="onMusicSearchFocus()" @blur="musicSearchFocused = false" type="text"
               :placeholder="searchMode === 'playlists' ? 'Search playlists...' : 'Search songs...'"
               class="flex-1 bg-surface-light rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:ring-1 focus:ring-accent">
        <button type="submit" class="bg-accent text-surface-dark px-3 py-1.5 rounded-lg text-sm">Search</button>
      </form>
      <!-- Search mode toggle -->
      <div class="flex gap-1 self-center bg-surface rounded-lg p-0.5">
        <button @click="setSearchMode('songs')" class="px-3 py-0.5 rounded text-xs font-medium transition-colors"
                :class="searchMode === 'songs' ? 'bg-accent text-surface-dark' : 'text-text-muted'">Songs</button>
        <button @click="setSearchMode('playlists')" class="px-3 py-0.5 rounded text-xs font-medium transition-colors"
                :class="searchMode === 'playlists' ? 'bg-accent text-surface-dark' : 'text-text-muted'">Playlists</button>
      </div>

      <!-- Main content area (relative for overlay) -->
      <div class="flex-1 relative min-h-0">

      <!-- Search Results / Recent suggestions (overlay) -->
      <div x-show="musicResults.length > 0 || playlistResults.length > 0 || (musicSearchFocused && !musicQuery.trim() && musicHistory.length > 0)" class="absolute inset-0 z-10 bg-surface-dark flex flex-col">
        <div class="flex items-center justify-between mb-1">
          <h3 class="text-sm font-medium text-text-muted" x-text="playlistResults.length > 0 ? 'Playlists' : musicResults.length > 0 ? 'Search Results' : 'Recently Played'"></h3>
          <button @click="musicResults = []; playlistResults = []; musicSearchFocused = false" class="text-xs text-text-dim hover:text-text">Close</button>
        </div>
        <div class="flex-1 overflow-y-auto space-y-1 min-h-0">
          <!-- Playlist search results -->
          <template x-for="(pl, i) in playlistResults" :key="'pl'+i">
            <div @click="fetchPlaylist(pl.browseId)" class="w-full flex items-center gap-2 p-2 rounded-lg bg-surface-light hover:bg-accent/20 cursor-pointer group">
              <img :src="pl.thumbnail" class="w-10 h-10 rounded object-cover shrink-0" x-show="pl.thumbnail">
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate" x-text="pl.title"></div>
                <div class="text-xs text-text-muted truncate" x-text="pl.author"></div>
              </div>
              <span class="text-xs text-text-dim shrink-0" x-text="pl.itemCount ? pl.itemCount + ' tracks' : ''"></span>
            </div>
          </template>
          <!-- Song search results -->
          <template x-for="(song, i) in musicResults" :key="i">
            <div class="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-accent/20 group"
                 :class="musicState.song?.videoId === song.videoId ? 'bg-accent/10 border border-accent/30' : 'bg-surface-light'">
              <div class="relative w-10 h-10 shrink-0">
                <img :src="song.thumbnail" class="w-10 h-10 rounded object-cover" x-show="song.thumbnail">
                <!-- Playing animation overlay for current song -->
                <div x-show="musicState.song?.videoId === song.videoId && musicState.is_playing"
                     @click="musicCmd('pause')"
                     class="absolute inset-0 flex items-center justify-center bg-black/60 rounded cursor-pointer">
                  <div class="flex items-end gap-[3px] h-4">
                    <span class="w-[3px] bg-accent rounded-full animate-[eq1_0.6s_ease-in-out_infinite]"></span>
                    <span class="w-[3px] bg-accent rounded-full animate-[eq2_0.7s_ease-in-out_infinite]"></span>
                    <span class="w-[3px] bg-accent rounded-full animate-[eq3_0.5s_ease-in-out_infinite]"></span>
                  </div>
                </div>
                <!-- Paused overlay for current song -->
                <div x-show="musicState.song?.videoId === song.videoId && !musicState.is_playing"
                     @click="musicCmd('pause')"
                     class="absolute inset-0 flex items-center justify-center bg-black/60 rounded cursor-pointer">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="white" class="opacity-80"><polygon points="6 3 21 12 6 21"/></svg>
                </div>
                <!-- Play hover for non-current songs -->
                <button x-show="musicState.song?.videoId !== song.videoId" @click="playSongInline(song)"
                        class="absolute inset-0 flex items-center justify-center bg-black/50 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><polygon points="6 3 21 12 6 21"/></svg>
                </button>
              </div>
              <div class="flex-1 min-w-0 cursor-pointer" @click="playSong(song)">
                <div class="text-sm truncate" :class="musicState.song?.videoId === song.videoId ? 'text-accent' : ''" x-text="song.title"></div>
                <div class="text-xs text-text-muted truncate" x-text="song.artist"></div>
                <div x-show="song.album" class="flex items-center gap-1 mt-0.5 min-w-0">
                  <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-text-dim shrink-0">
                    <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
                  </svg>
                  <button x-show="song.albumId" @click.stop="fetchAlbum(song.albumId); albumView = null; musicResults = []; musicSearchFocused = false"
                          class="text-[11px] text-accent/70 hover:text-accent truncate" x-text="song.album"></button>
                  <span x-show="!song.albumId" class="text-[11px] text-text-dim truncate" x-text="song.album"></span>
                </div>
              </div>
              <span class="text-xs text-text-dim mr-1" x-text="song.duration"></span>
              <!-- Add to queue button -->
              <button @click.stop="addToQueue(song)"
                      class="w-7 h-7 shrink-0 flex items-center justify-center rounded-full text-text-dim hover:text-accent hover:bg-accent/20 transition-colors"
                      title="Add to queue">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </button>
              <!-- Pause button for current song, play for others -->
              <button x-show="musicState.song?.videoId === song.videoId && musicState.is_playing"
                      @click="musicCmd('pause')"
                      class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>
                </svg>
              </button>
              <button x-show="musicState.song?.videoId === song.videoId && !musicState.is_playing"
                      @click="musicCmd('pause')"
                      class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
              </button>
              <button x-show="musicState.song?.videoId !== song.videoId"
                      @click="playSongInline(song)"
                      class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
              </button>
            </div>
          </template>
          <!-- Recent suggestions when search is empty -->
          <template x-if="musicResults.length === 0">
            <template x-for="(entry, i) in musicHistory" :key="'h'+i">
              <div class="w-full flex items-center gap-2 p-2 rounded-lg bg-surface-light hover:bg-accent/20 group">
                <div class="relative w-10 h-10 shrink-0">
                  <img :src="entry.song.thumbnail" class="w-10 h-10 rounded object-cover" x-show="entry.song.thumbnail">
                  <button @click="playSongInline(entry.song)"
                          class="absolute inset-0 flex items-center justify-center bg-black/50 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><polygon points="6 3 21 12 6 21"/></svg>
                  </button>
                </div>
                <div class="flex-1 min-w-0 cursor-pointer" @click="playSong(entry.song)">
                  <div class="text-sm truncate" x-text="entry.song.title"></div>
                  <div class="text-xs text-text-muted truncate" x-text="entry.song.artist"></div>
                </div>
                <span class="text-xs text-text-dim mr-1" x-text="entry.song.duration"></span>
                <button @click.stop="addToQueue(entry.song)"
                        class="w-7 h-7 shrink-0 flex items-center justify-center rounded-full text-text-dim hover:text-accent hover:bg-accent/20 transition-colors"
                        title="Add to queue">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                </button>
                <button @click="playSongInline(entry.song)"
                        class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110 transition-all">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
                </button>
              </div>
            </template>
          </template>
        </div>
        <!-- Mini player bar (shown when a song is playing) -->
        <div x-show="musicState.song" @click="musicResults = []; playlistResults = []"
             class="shrink-0 flex items-center gap-2 p-2 mt-1 rounded-lg bg-surface-light border border-white/10 cursor-pointer">
          <img :src="musicState.song?.thumbnail" class="w-9 h-9 rounded object-cover" x-show="musicState.song?.thumbnail">
          <div class="flex-1 min-w-0">
            <div class="text-xs font-medium truncate" x-text="musicState.song?.title"></div>
            <div class="text-[10px] text-text-muted truncate" x-text="musicState.song?.artist"></div>
          </div>
          <button @click.stop="musicCmd('previous')" class="w-7 h-7 flex items-center justify-center rounded-full text-text-muted hover:text-text hover:bg-white/10">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="5" width="3" height="14" rx="0.5"/><polygon points="21 5 9 12 21 19"/>
            </svg>
          </button>
          <button @click.stop="musicCmd('pause')"
                  class="w-9 h-9 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110">
            <template x-if="musicState.is_playing">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>
              </svg>
            </template>
            <template x-if="!musicState.is_playing">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="6 3 21 12 6 21"/>
              </svg>
            </template>
          </button>
          <button @click.stop="musicCmd('next')" class="w-7 h-7 flex items-center justify-center rounded-full text-text-muted hover:text-text hover:bg-white/10">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <polygon points="3 5 15 12 3 19"/><rect x="18" y="5" width="3" height="14" rx="0.5"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- History View (overlay on top of everything) -->
      <div x-show="showHistory" class="absolute inset-0 z-10 bg-surface-dark flex flex-col">
        <div class="flex items-center justify-between mb-1 shrink-0">
          <h3 class="text-sm font-medium text-text-muted">Recently Played</h3>
          <button @click="showHistory = false" class="text-xs text-text-dim hover:text-text">Close</button>
        </div>
        <div class="flex-1 overflow-y-auto space-y-1 min-h-0">
          <template x-if="musicHistory.length === 0">
            <p class="text-xs text-text-dim text-center py-6">No songs played yet</p>
          </template>
          <template x-for="(entry, i) in musicHistory" :key="i">
            <div class="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-accent/20 group"
                 :class="musicState.song?.videoId === entry.song.videoId ? 'bg-accent/10 border border-accent/30' : 'bg-surface-light'">
              <div class="relative w-10 h-10 shrink-0">
                <img :src="entry.song.thumbnail" class="w-10 h-10 rounded object-cover" x-show="entry.song.thumbnail">
                <div x-show="musicState.song?.videoId === entry.song.videoId && musicState.is_playing"
                     @click="musicCmd('pause')"
                     class="absolute inset-0 flex items-center justify-center bg-black/60 rounded cursor-pointer">
                  <div class="flex items-end gap-[3px] h-4">
                    <span class="w-[3px] bg-accent rounded-full animate-[eq1_0.6s_ease-in-out_infinite]"></span>
                    <span class="w-[3px] bg-accent rounded-full animate-[eq2_0.7s_ease-in-out_infinite]"></span>
                    <span class="w-[3px] bg-accent rounded-full animate-[eq3_0.5s_ease-in-out_infinite]"></span>
                  </div>
                </div>
                <div x-show="musicState.song?.videoId === entry.song.videoId && !musicState.is_playing"
                     @click="musicCmd('pause')"
                     class="absolute inset-0 flex items-center justify-center bg-black/60 rounded cursor-pointer">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="white" class="opacity-80"><polygon points="6 3 21 12 6 21"/></svg>
                </div>
                <button x-show="musicState.song?.videoId !== entry.song.videoId" @click="playSongInline(entry.song)"
                        class="absolute inset-0 flex items-center justify-center bg-black/50 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><polygon points="6 3 21 12 6 21"/></svg>
                </button>
              </div>
              <div class="flex-1 min-w-0 cursor-pointer" @click="playSong(entry.song)">
                <div class="text-sm truncate" :class="musicState.song?.videoId === entry.song.videoId ? 'text-accent' : ''" x-text="entry.song.title"></div>
                <div class="text-xs text-text-muted truncate" x-text="entry.song.artist"></div>
              </div>
              <span class="text-xs text-text-dim mr-1" x-text="entry.song.duration"></span>
              <button @click.stop="addToQueue(entry.song)"
                      class="w-7 h-7 shrink-0 flex items-center justify-center rounded-full text-text-dim hover:text-accent hover:bg-accent/20 transition-colors"
                      title="Add to queue">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </button>
              <button x-show="musicState.song?.videoId === entry.song.videoId && musicState.is_playing"
                      @click="musicCmd('pause')"
                      class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>
                </svg>
              </button>
              <button x-show="musicState.song?.videoId === entry.song.videoId && !musicState.is_playing"
                      @click="musicCmd('pause')"
                      class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
              </button>
              <button x-show="musicState.song?.videoId !== entry.song.videoId"
                      @click="playSongInline(entry.song)"
                      class="w-8 h-8 shrink-0 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110 transition-all">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
              </button>
            </div>
          </template>
        </div>
        <!-- Mini player bar -->
        <div x-show="musicState.song" @click="showHistory = false"
             class="shrink-0 flex items-center gap-2 p-2 mt-1 rounded-lg bg-surface-light border border-white/10 cursor-pointer">
          <img :src="musicState.song?.thumbnail" class="w-9 h-9 rounded object-cover" x-show="musicState.song?.thumbnail">
          <div class="flex-1 min-w-0">
            <div class="text-xs font-medium truncate" x-text="musicState.song?.title"></div>
            <div class="text-[10px] text-text-muted truncate" x-text="musicState.song?.artist"></div>
          </div>
          <button @click.stop="musicCmd('previous')" class="w-7 h-7 flex items-center justify-center rounded-full text-text-muted hover:text-text hover:bg-white/10">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="5" width="3" height="14" rx="0.5"/><polygon points="21 5 9 12 21 19"/>
            </svg>
          </button>
          <button @click.stop="musicCmd('pause')"
                  class="w-9 h-9 flex items-center justify-center rounded-full bg-accent text-surface-dark hover:brightness-110">
            <template x-if="musicState.is_playing">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>
              </svg>
            </template>
            <template x-if="!musicState.is_playing">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="6 3 21 12 6 21"/>
              </svg>
            </template>
          </button>
          <button @click.stop="musicCmd('next')" class="w-7 h-7 flex items-center justify-center rounded-full text-text-muted hover:text-text hover:bg-white/10">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <polygon points="3 5 15 12 3 19"/><rect x="18" y="5" width="3" height="14" rx="0.5"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Queue Overlay -->
      <div x-show="showQueue" class="absolute inset-0 z-20 bg-surface-dark flex flex-col">
        <div class="flex items-center justify-between mb-1 shrink-0">
          <h3 class="text-sm font-medium text-text-muted">Queue (<span x-text="(musicState.queue || []).length"></span> songs)</h3>
          <button @click="showQueue = false" class="text-xs text-text-dim hover:text-text">Close</button>
        </div>
        <div class="flex-1 overflow-y-auto space-y-0.5 min-h-0">
          <template x-if="(musicState.queue || []).length === 0">
            <p class="text-xs text-text-dim text-center py-6">Queue is empty — search for songs to add</p>
          </template>
          <template x-for="(qSong, qi) in (musicState.queue || [])" :key="'q'+qi">
            <div class="w-full flex items-center gap-2 px-2 py-1.5 rounded-lg group"
                 :class="qi === musicState.queue_index ? 'bg-accent/15 border border-accent/30' : 'bg-surface-light hover:bg-accent/10'">
              <span class="text-[10px] text-text-dim w-4 text-right shrink-0" x-text="qi + 1"></span>
              <img :src="qSong.thumbnail" class="w-9 h-9 rounded object-cover shrink-0" x-show="qSong.thumbnail">
              <div class="flex-1 min-w-0 cursor-pointer" @click="playSong(qSong)">
                <div class="text-xs truncate" :class="qi === musicState.queue_index ? 'text-accent font-medium' : ''" x-text="qSong.title"></div>
                <div class="text-[10px] text-text-muted truncate" x-text="qSong.artist"></div>
              </div>
              <span class="text-[10px] text-text-dim shrink-0" x-text="qSong.duration"></span>
              <button x-show="qi !== musicState.queue_index" @click.stop="removeFromQueue(qi)"
                      class="w-6 h-6 shrink-0 flex items-center justify-center rounded-full text-text-dim hover:text-red-400 hover:bg-red-900/30 opacity-0 group-hover:opacity-100 transition-all"
                      title="Remove from queue">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
              <!-- Equalizer icon for currently playing -->
              <div x-show="qi === musicState.queue_index && musicState.is_playing" class="flex items-end gap-[2px] h-3 shrink-0 w-6 justify-center">
                <span class="w-[2px] bg-accent rounded-full animate-[eq1_0.6s_ease-in-out_infinite]" style="height:8px"></span>
                <span class="w-[2px] bg-accent rounded-full animate-[eq2_0.7s_ease-in-out_infinite]" style="height:12px"></span>
                <span class="w-[2px] bg-accent rounded-full animate-[eq3_0.5s_ease-in-out_infinite]" style="height:6px"></span>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Lyrics Overlay -->
      <div x-show="showLyrics" class="absolute inset-0 z-[18] bg-surface-dark flex flex-col">
        <div class="flex items-center justify-between mb-1 shrink-0 px-1">
          <h3 class="text-sm font-medium text-text-muted">Lyrics</h3>
          <button @click="showLyrics = false" class="text-xs text-text-dim hover:text-text">Close</button>
        </div>
        <div class="flex-1 overflow-y-auto px-2 min-h-0">
          <div x-show="lyricsLoading" class="text-xs text-text-muted text-center py-6 animate-pulse">Loading lyrics...</div>
          <pre x-show="!lyricsLoading" class="text-xs text-text whitespace-pre-wrap font-sans leading-relaxed" x-text="currentLyrics"></pre>
          <div x-show="lyricsSource" class="text-[10px] text-text-dim mt-2" x-text="'Source: ' + lyricsSource"></div>
        </div>
      </div>

      <!-- Album/Playlist View Overlay -->
      <div x-show="albumView" class="absolute inset-0 z-[15] bg-surface-dark flex flex-col">
        <!-- Album header -->
        <div class="flex items-center gap-3 p-2 shrink-0">
          <img :src="albumView?.thumbnail" class="w-16 h-16 rounded-lg object-cover shadow-lg shrink-0" x-show="albumView?.thumbnail">
          <div class="flex-1 min-w-0">
            <div class="font-medium text-sm truncate" x-text="albumView?.title"></div>
            <div class="text-xs text-text-muted truncate" x-text="(albumView?.artist || '') + (albumView?.year ? ' \u2022 ' + albumView.year : '') + (albumView?.trackCount ? ' \u2022 ' + albumView.trackCount + ' tracks' : '')"></div>
            <button @click="addAlbumToQueue()" class="mt-1 text-[10px] bg-accent/20 text-accent hover:bg-accent/30 px-2 py-0.5 rounded transition-colors">
              Add All to Queue
            </button>
          </div>
        </div>
        <div class="border-t border-surface-light mx-2"></div>
        <!-- Tracklist -->
        <div class="flex-1 overflow-y-auto px-2 py-1 space-y-0.5 min-h-0">
          <template x-for="(track, ti) in (albumView?.tracks || [])" :key="'at'+ti">
            <div class="flex items-center gap-2 px-1.5 py-1 rounded-lg group hover:bg-accent/10"
                 :class="musicState.song?.videoId === track.videoId ? 'bg-accent/15' : ''">
              <!-- Track number or equalizer -->
              <div class="w-5 text-center shrink-0">
                <span x-show="musicState.song?.videoId !== track.videoId || !musicState.is_playing"
                      class="text-[10px]" :class="musicState.song?.videoId === track.videoId ? 'text-accent font-bold' : 'text-text-dim'" x-text="ti + 1"></span>
                <div x-show="musicState.song?.videoId === track.videoId && musicState.is_playing" class="flex items-end gap-[2px] h-3 justify-center">
                  <span class="w-[2px] bg-accent rounded-full animate-[eq1_0.6s_ease-in-out_infinite]" style="height:6px"></span>
                  <span class="w-[2px] bg-accent rounded-full animate-[eq2_0.7s_ease-in-out_infinite]" style="height:10px"></span>
                  <span class="w-[2px] bg-accent rounded-full animate-[eq3_0.5s_ease-in-out_infinite]" style="height:5px"></span>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-xs truncate" :class="musicState.song?.videoId === track.videoId ? 'text-accent font-medium' : ''" x-text="track.title"></div>
              </div>
              <span class="text-[10px] text-text-dim shrink-0" x-text="track.duration"></span>
              <!-- Add to queue -->
              <button @click.stop="addToQueue(track)"
                      class="w-6 h-6 shrink-0 flex items-center justify-center rounded-full text-text-dim hover:text-accent hover:bg-accent/20 opacity-0 group-hover:opacity-100 transition-all"
                      title="Add to queue">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </button>
              <!-- Play -->
              <button @click.stop="playSongFromAlbum(track)"
                      class="w-6 h-6 shrink-0 flex items-center justify-center rounded-full text-text-dim hover:text-accent hover:bg-accent/20 opacity-0 group-hover:opacity-100 transition-all"
                      title="Play">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
              </button>
            </div>
          </template>
        </div>
        <div class="border-t border-surface-light mx-2"></div>
        <!-- Back button -->
        <button @click="albumView = null" class="shrink-0 flex items-center justify-center gap-1 py-1.5 text-xs text-text-muted hover:text-accent transition-colors">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          Back to Now Playing
        </button>
      </div>

      <!-- Idle state — most played + recently played cards -->
      <div x-show="!musicState.song" class="h-full overflow-y-auto">
        <!-- Most Played -->
        <template x-if="musicMostPlayed.length > 0">
          <div class="mb-2">
            <h3 class="text-xs font-medium text-text-dim uppercase tracking-wide mb-1.5">Most Played</h3>
            <div class="grid grid-cols-4 gap-1.5">
              <template x-for="(song, i) in musicMostPlayed.slice(0, 4)" :key="'mp'+i">
                <button @click="playSongInline(song)" class="group flex flex-col gap-1 p-1.5 rounded-lg bg-surface-light hover:bg-accent/20 transition-colors">
                  <div class="relative w-full h-[72px]">
                    <img :src="song.thumbnail" class="w-full h-full rounded object-cover">
                    <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><polygon points="6 3 21 12 6 21"/></svg>
                    </div>
                  </div>
                  <div class="w-full text-[10px] truncate" x-text="song.title"></div>
                  <div class="w-full text-[9px] text-text-dim truncate -mt-0.5" x-text="song.artist"></div>
                </button>
              </template>
            </div>
          </div>
        </template>
        <!-- Recently Played -->
        <template x-if="musicHistory.length > 0">
          <div>
            <h3 class="text-xs font-medium text-text-dim uppercase tracking-wide mb-1.5">Recently Played</h3>
            <div class="grid grid-cols-4 gap-1.5">
              <template x-for="(entry, i) in musicHistory.slice(0, 4)" :key="'rp'+i">
                <button @click="playSongInline(entry.song)" class="group flex flex-col gap-1 p-1.5 rounded-lg bg-surface-light hover:bg-accent/20 transition-colors">
                  <div class="relative w-full h-[72px]">
                    <img :src="entry.song.thumbnail" class="w-full h-full rounded object-cover">
                    <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><polygon points="6 3 21 12 6 21"/></svg>
                    </div>
                  </div>
                  <div class="w-full text-[10px] truncate" x-text="entry.song.title"></div>
                  <div class="w-full text-[9px] text-text-dim truncate -mt-0.5" x-text="entry.song.artist"></div>
                </button>
              </template>
            </div>
          </div>
        </template>
        <!-- View History button -->
        <template x-if="musicHistory.length > 0">
          <button @click="showHistory = true; fetchMusicHistory()"
                  class="w-full mt-2 flex items-center justify-center gap-1.5 bg-surface-light hover:bg-accent/20 text-text-muted hover:text-accent rounded-lg px-3 py-2 text-xs transition-colors">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
            View All History
          </button>
        </template>
        <!-- Empty state -->
        <template x-if="musicMostPlayed.length === 0 && musicHistory.length === 0">
          <div class="h-full flex items-center justify-center">
            <p class="text-sm text-text-dim">Search for a song to get started</p>
          </div>
        </template>
      </div>

      <!-- Now Playing -->
      <div x-show="musicState.song" class="h-full flex flex-col items-center justify-between py-1">
        <!-- Song info: art + text side by side -->
        <div class="flex items-center gap-3 w-full max-w-xs">
          <img :src="musicState.song?.thumbnail" class="w-20 h-20 rounded-lg object-cover shadow-lg shrink-0" x-show="musicState.song?.thumbnail">
          <div class="min-w-0">
            <div class="font-medium text-sm leading-tight truncate" x-text="musicState.song?.title"></div>
            <div class="text-xs text-text-muted truncate mt-0.5" x-text="musicState.song?.artist"></div>
          </div>
        </div>
        <!-- Progress -->
        <div class="w-full max-w-xs">
          <div class="bg-surface-light rounded-full h-1.5 cursor-pointer" @click="seekMusic($event)">
            <div class="bg-accent rounded-full h-1.5" :style="'width:' + musicProgress + '%'"></div>
          </div>
          <div class="flex justify-between text-[10px] text-text-dim mt-0.5">
            <span x-text="formatTime(musicState.position)"></span>
            <span x-text="formatTime(musicState.duration)"></span>
          </div>
        </div>
        <!-- Controls -->
        <div class="flex items-center gap-3">
          <button @click="musicCmd('shuffle')" class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors"
                  :class="musicState.shuffle ? 'text-accent' : 'text-text-dim'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/>
              <polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/>
              <line x1="4" y1="4" x2="9" y2="9"/>
            </svg>
          </button>
          <button @click="musicCmd('previous')" class="w-8 h-8 flex items-center justify-center rounded-full text-text-muted hover:text-text hover:bg-white/10 transition-colors">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="5" width="3" height="14" rx="0.5"/><polygon points="21 5 9 12 21 19"/>
            </svg>
          </button>
          <button @click="musicCmd('pause')"
                  class="w-10 h-10 rounded-full bg-accent text-surface-dark flex items-center justify-center hover:brightness-110 transition-all">
            <template x-if="musicState.is_playing">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>
              </svg>
            </template>
            <template x-if="!musicState.is_playing">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="6 3 21 12 6 21"/>
              </svg>
            </template>
          </button>
          <button @click="musicCmd('next')" class="w-8 h-8 flex items-center justify-center rounded-full text-text-muted hover:text-text hover:bg-white/10 transition-colors">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <polygon points="3 5 15 12 3 19"/><rect x="18" y="5" width="3" height="14" rx="0.5"/>
            </svg>
          </button>
          <button @click="musicCmd('repeat')" class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors relative"
                  :class="musicState.repeat !== 'off' ? 'text-accent' : 'text-text-dim'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/>
              <polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
            </svg>
            <span x-show="musicState.repeat === 'one'" class="absolute -top-0.5 -right-0.5 text-[9px] font-bold text-accent">1</span>
          </button>
        </div>
        <!-- Volume slider -->
        <div class="flex items-center gap-2 w-full max-w-xs">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-text-dim shrink-0">
            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
          </svg>
          <input type="range" min="0" max="100" :value="musicState.volume"
                 @input="setVolume(parseInt($event.target.value))"
                 class="flex-1 h-1 accent-amber-500 cursor-pointer">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-text-dim shrink-0">
            <path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.08"/>
          </svg>
        </div>
        <!-- Album link -->
        <div x-show="musicState.song?.albumId" class="flex items-center justify-center">
          <button @click="fetchAlbum(musicState.song.albumId)"
                  class="text-[10px] text-accent/70 hover:text-accent transition-colors truncate max-w-xs" x-text="musicState.song?.album || 'View Album'"></button>
        </div>
        <!-- Device + History + Queue + Lyrics row -->
        <div class="flex items-center justify-center gap-2">
          <button @click="showHistory = true; fetchMusicHistory()"
                  class="flex items-center gap-1 bg-surface-light text-text-muted text-[11px] rounded px-2 py-1 hover:bg-white/10 transition-colors">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
            History
          </button>
          <button @click="fetchLyrics()"
                  class="flex items-center gap-1 bg-surface-light text-text-muted text-[11px] rounded px-2 py-1 hover:bg-white/10 transition-colors">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
            </svg>
            Lyrics
          </button>
          <button @click="showQueue = true"
                  class="flex items-center gap-1 bg-surface-light text-text-muted text-[11px] rounded px-2 py-1 hover:bg-white/10 transition-colors relative">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Queue
            <span x-show="musicState.queue_length > 1"
                  class="absolute -top-1.5 -right-1.5 bg-accent text-surface-dark text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center"
                  x-text="musicState.queue_length"></span>
          </button>
          <div class="relative" x-data="{ deviceOpen: false }">
            <button @click="deviceOpen = !deviceOpen"
                    class="flex items-center gap-1 bg-surface-light text-text-muted text-[11px] rounded px-2 py-1 hover:bg-white/10 transition-colors max-w-[200px]">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.08"/>
              </svg>
              <span class="truncate" x-text="musicState.output_device || 'Select device'"></span>
              <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor" class="shrink-0 opacity-50">
                <polygon points="12 8 6 14 18 14"/>
              </svg>
            </button>
            <div x-show="deviceOpen" x-cloak @click.away="deviceOpen = false"
                 x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-1"
                 class="absolute bottom-full left-0 mb-1 w-72 bg-surface-dark border border-white/10 rounded-lg shadow-xl overflow-y-auto max-h-48 z-50">
              <template x-for="d in musicDevices" :key="d.name">
                <button @click="castMusic(d.name); musicState.output_device = d.name; deviceOpen = false"
                        class="w-full text-left text-xs px-3 py-2 hover:bg-accent/20 transition-colors truncate"
                        :class="musicState.output_device === d.name ? 'text-accent bg-accent/10' : 'text-text-muted'">
                  <span x-text="d.label"></span>
                </button>
              </template>
            </div>
          </div>
        </div>
      </div>
      </div><!-- /relative container -->
    </div>

    <!-- Calendar Tab -->
    <div x-show="tab === 'calendar'"
         :class="swipeDirection === 'left' ? 'tab-slide-enter-left' : swipeDirection === 'right' ? 'tab-slide-enter-right' : ''"
         class="h-full flex flex-col p-3">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-medium text-accent">Calendar</h2>
        <div class="flex gap-1">
          <button @click="calDays=1" class="px-2 py-0.5 rounded text-xs"
                  :class="calDays===1 ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'">Day</button>
          <button @click="calDays=7" class="px-2 py-0.5 rounded text-xs"
                  :class="calDays===7 ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'">Week</button>
          <button @click="showEventForm = !showEventForm" class="px-2 py-0.5 rounded text-xs bg-accent text-surface-dark">+ Add</button>
        </div>
      </div>
      <!-- Offline banner -->
      <div x-show="calOffline" x-transition class="bg-amber-900/40 border border-amber-600/30 rounded-lg px-3 py-1.5 mb-1 text-xs text-amber-300 text-center">
        Offline &mdash; changes will sync when connected
      </div>

      <!-- Add Event Form -->
      <div x-show="showEventForm" x-transition class="bg-surface-light rounded-lg p-2 mb-1 space-y-1 overflow-y-auto max-h-[290px]">
        <input x-model="newEvent.summary" type="text" placeholder="Event title"
               class="w-full bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        <div class="flex gap-2 items-center">
          <label class="flex items-center gap-1 text-xs text-text-muted cursor-pointer shrink-0">
            <input type="checkbox" x-model="newEvent.allDay" class="accent-accent w-3 h-3"> All day
          </label>
          <input x-model="newEvent.date" type="date"
                 class="flex-1 bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        </div>
        <div x-show="!newEvent.allDay" class="flex gap-2">
          <input x-model="newEvent.startTime" type="time"
                 class="flex-1 bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
          <select x-model="newEvent.durationHrs" class="flex-1 bg-surface rounded px-2 py-1 text-xs text-text outline-none">
            <option value="0.25">15 min</option><option value="0.5">30 min</option><option value="0.75">45 min</option>
            <option value="1" selected>1 hour</option><option value="1.5">1.5 hrs</option><option value="2">2 hours</option>
            <option value="3">3 hours</option><option value="4">4 hours</option><option value="8">8 hours</option>
          </select>
        </div>
        <input x-model="newEvent.location" type="text" placeholder="Add location" id="newEventLocation"
               x-init="$watch('showEventForm', v => { if(v) $nextTick(() => initPlacesAutocomplete('newEventLocation', loc => newEvent.location = loc)) })"
               class="w-full bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        <input x-model="newEvent.description" type="text" placeholder="Description (optional)"
               class="w-full bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        <div class="flex flex-wrap gap-1">
          <template x-for="opt in [{v:'none',l:'None'},{v:'daily',l:'Daily'},{v:'weekly',l:'Weekly'},{v:'monthly',l:'Monthly'},{v:'yearly',l:'Yearly'},{v:'weekdays',l:'M-F'},{v:'custom',l:'Custom'}]" :key="opt.v">
            <button @click="newEvent.repeatMode = opt.v" type="button" class="px-2 py-0.5 rounded text-xs"
                    :class="newEvent.repeatMode === opt.v ? 'bg-accent text-surface-dark' : 'bg-surface text-text-muted'"
                    x-text="opt.l"></button>
          </template>
        </div>
        <div x-show="newEvent.repeatMode === 'custom'" class="bg-surface rounded p-2 space-y-1.5">
          <div class="flex gap-1.5 items-center">
            <span class="text-xs text-text-muted shrink-0">Every</span>
            <input x-model.number="newEvent.customInterval" type="number" min="1" max="99"
                   class="w-12 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none text-center">
            <select x-model="newEvent.customFreq" class="flex-1 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none">
              <option value="DAILY">day(s)</option><option value="WEEKLY">week(s)</option>
              <option value="MONTHLY">month(s)</option><option value="YEARLY">year(s)</option>
            </select>
          </div>
          <div x-show="newEvent.customFreq === 'WEEKLY'" class="flex gap-1 justify-center">
            <template x-for="d in ['MO','TU','WE','TH','FR','SA','SU']" :key="d">
              <button @click="toggleDay(newEvent, d)" type="button"
                      class="w-7 h-7 rounded-full text-xs font-medium"
                      :class="newEvent.customDays.includes(d) ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'"
                      x-text="d.charAt(0)"></button>
            </template>
          </div>
          <div class="flex gap-1.5 items-center">
            <span class="text-xs text-text-muted shrink-0">Ends</span>
            <select x-model="newEvent.customEnd" class="flex-1 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none">
              <option value="never">Never</option><option value="date">On date</option><option value="count">After #</option>
            </select>
            <input x-show="newEvent.customEnd === 'date'" x-model="newEvent.customEndDate" type="date"
                   class="flex-1 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none">
            <input x-show="newEvent.customEnd === 'count'" x-model.number="newEvent.customCount" type="number" min="1" max="999"
                   class="w-14 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none text-center" placeholder="#">
          </div>
        </div>
        <div class="flex gap-2 justify-end pt-0.5">
          <button @click="showEventForm = false" class="px-3 py-0.5 rounded text-xs bg-surface text-text-muted">Cancel</button>
          <button @click="createCalEvent()" class="px-3 py-0.5 rounded text-xs bg-accent text-surface-dark font-medium">Create</button>
        </div>
      </div>

      <!-- Edit Event Form -->
      <div x-show="editingEvent" x-transition class="bg-surface-light rounded-lg p-2 mb-1 space-y-1 border border-accent/30 overflow-y-auto max-h-[290px]">
        <div class="text-xs text-accent font-medium">Edit Event</div>
        <input x-model="editEvent.summary" type="text" placeholder="Event title"
               class="w-full bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        <div class="flex gap-2 items-center">
          <label class="flex items-center gap-1 text-xs text-text-muted cursor-pointer shrink-0">
            <input type="checkbox" x-model="editEvent.allDay" class="accent-accent w-3 h-3"> All day
          </label>
          <input x-model="editEvent.date" type="date"
                 class="flex-1 bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        </div>
        <div x-show="!editEvent.allDay" class="flex gap-2">
          <input x-model="editEvent.startTime" type="time"
                 class="flex-1 bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
          <input x-model="editEvent.endTime" type="time"
                 class="flex-1 bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        </div>
        <input x-model="editEvent.location" type="text" placeholder="Add location" id="editEventLocation"
               x-init="$watch('editingEvent', v => { if(v) $nextTick(() => initPlacesAutocomplete('editEventLocation', loc => editEvent.location = loc)) })"
               class="w-full bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        <input x-model="editEvent.description" type="text" placeholder="Description (optional)"
               class="w-full bg-surface rounded px-2 py-1 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        <div class="flex flex-wrap gap-1">
          <template x-for="opt in [{v:'none',l:'None'},{v:'daily',l:'Daily'},{v:'weekly',l:'Weekly'},{v:'monthly',l:'Monthly'},{v:'yearly',l:'Yearly'},{v:'weekdays',l:'M-F'},{v:'custom',l:'Custom'}]" :key="opt.v">
            <button @click="editEvent.repeatMode = opt.v" type="button" class="px-2 py-0.5 rounded text-xs"
                    :class="editEvent.repeatMode === opt.v ? 'bg-accent text-surface-dark' : 'bg-surface text-text-muted'"
                    x-text="opt.l"></button>
          </template>
        </div>
        <div x-show="editEvent.repeatMode === 'custom'" class="bg-surface rounded p-2 space-y-1.5">
          <div class="flex gap-1.5 items-center">
            <span class="text-xs text-text-muted shrink-0">Every</span>
            <input x-model.number="editEvent.customInterval" type="number" min="1" max="99"
                   class="w-12 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none text-center">
            <select x-model="editEvent.customFreq" class="flex-1 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none">
              <option value="DAILY">day(s)</option><option value="WEEKLY">week(s)</option>
              <option value="MONTHLY">month(s)</option><option value="YEARLY">year(s)</option>
            </select>
          </div>
          <div x-show="editEvent.customFreq === 'WEEKLY'" class="flex gap-1 justify-center">
            <template x-for="d in ['MO','TU','WE','TH','FR','SA','SU']" :key="d">
              <button @click="toggleDay(editEvent, d)" type="button"
                      class="w-7 h-7 rounded-full text-xs font-medium"
                      :class="editEvent.customDays.includes(d) ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'"
                      x-text="d.charAt(0)"></button>
            </template>
          </div>
          <div class="flex gap-1.5 items-center">
            <span class="text-xs text-text-muted shrink-0">Ends</span>
            <select x-model="editEvent.customEnd" class="flex-1 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none">
              <option value="never">Never</option><option value="date">On date</option><option value="count">After #</option>
            </select>
            <input x-show="editEvent.customEnd === 'date'" x-model="editEvent.customEndDate" type="date"
                   class="flex-1 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none">
            <input x-show="editEvent.customEnd === 'count'" x-model.number="editEvent.customCount" type="number" min="1" max="999"
                   class="w-14 bg-surface-light rounded px-1.5 py-0.5 text-xs text-text outline-none text-center" placeholder="#">
          </div>
        </div>
        <div class="flex gap-2 justify-end pt-0.5">
          <button @click="editingEvent = null" class="px-3 py-0.5 rounded text-xs bg-surface text-text-muted">Cancel</button>
          <button @click="updateCalEvent()" class="px-3 py-0.5 rounded text-xs bg-accent text-surface-dark font-medium">Save</button>
        </div>
      </div>

      <!-- Event List -->
      <div class="flex-1 overflow-y-auto space-y-1.5">
        <template x-for="(event, i) in calEvents" :key="event.id || i">
          <div @click="startEditEvent(event)" class="bg-surface-light rounded-lg px-3 py-2 border-l-3 border-accent group cursor-pointer hover:bg-surface-light/80">
            <div class="flex justify-between items-start">
              <div class="font-medium text-sm" x-text="event.summary"></div>
              <div class="flex items-center gap-1">
                <span x-show="event.recurring || (event.recurrence && event.recurrence.length > 0)" class="text-xs text-text-dim">&#x1F501;</span>
                <span x-show="event.all_day" class="text-xs text-accent bg-accent/10 px-1.5 rounded">All Day</span>
                <button @click.stop="deleteCalEvent(event.id)" class="text-xs text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity px-1">Del</button>
              </div>
            </div>
            <div class="text-xs text-text-muted mt-0.5" x-text="event.start + (event.end && !event.all_day ? ' — ' + event.end : '')"></div>
            <div x-show="event.location" class="text-xs text-text-dim mt-0.5" x-text="event.location"></div>
          </div>
        </template>
        <div x-show="calEvents.length === 0" class="text-center text-text-muted py-8">No events</div>
      </div>
    </div>

    <!-- TV Remote Tab -->
    <div x-show="tab === 'tv'"
         :class="swipeDirection === 'left' ? 'tab-slide-enter-left' : swipeDirection === 'right' ? 'tab-slide-enter-right' : ''"
         class="h-full flex flex-col p-3 gap-2 relative">
      <!-- App Launcher Row -->
      <div class="flex gap-1.5 justify-center">
        <button @click="tvLaunch('youtube')" class="w-12 h-10 rounded-lg bg-surface-light hover:brightness-125 flex items-center justify-center overflow-hidden" title="YouTube">
          <img src="/static/img/YouTube.png" class="w-10 h-8 object-contain">
        </button>
        <button @click="tvLaunch('netflix')" class="w-12 h-10 rounded-lg bg-surface-light hover:brightness-125 flex items-center justify-center overflow-hidden" title="Netflix">
          <img src="/static/img/Netflix.png" class="w-10 h-8 object-contain">
        </button>
        <button @click="tvLaunch('crunchyroll')" class="w-12 h-10 rounded-lg bg-surface-light hover:brightness-125 flex items-center justify-center overflow-hidden" title="Crunchyroll">
          <img src="/static/img/Crunchyroll.png" class="w-10 h-8 object-contain">
        </button>
        <button @click="tvLaunch('twitch')" class="w-12 h-10 rounded-lg bg-surface-light hover:brightness-125 flex items-center justify-center overflow-hidden" title="Twitch">
          <img src="/static/img/Twitch.png" class="w-10 h-8 object-contain">
        </button>
        <button @click="tvLaunch('prime')" class="w-12 h-10 rounded-lg bg-surface-light hover:brightness-125 flex items-center justify-center overflow-hidden" title="Prime Video">
          <img src="/static/img/PrimeVIdeo.png" class="w-10 h-8 object-contain">
        </button>
        <button @click="tvLaunch('plex')" class="w-12 h-10 rounded-lg bg-surface-light hover:brightness-125 flex items-center justify-center overflow-hidden" title="Plex">
          <img src="/static/img/Plex.png" class="w-10 h-8 object-contain">
        </button>
      </div>
      <!-- D-Pad Grid -->
      <div class="flex-1 flex items-center justify-center">
        <div class="grid grid-cols-3 gap-1.5 w-48">
          <div></div>
          <button @click="tvKey('up')" class="h-12 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-xl text-text-muted">&#x25B2;</button>
          <div></div>
          <button @click="tvKey('left')" class="h-12 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-xl text-text-muted">&#x25C0;</button>
          <button @click="tvKey('select')" class="h-12 rounded-lg bg-accent hover:bg-accent-light flex items-center justify-center text-sm font-bold text-surface-dark">OK</button>
          <button @click="tvKey('right')" class="h-12 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-xl text-text-muted">&#x25B6;</button>
          <div></div>
          <button @click="tvKey('down')" class="h-12 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-xl text-text-muted">&#x25BC;</button>
          <div></div>
        </div>
      </div>
      <!-- Media Controls -->
      <div class="flex gap-2 justify-center">
        <button @click="tvKey('rewind')" class="w-10 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-text-muted text-sm">&#x23EE;</button>
        <button @click="tvKey('play_pause')" class="w-10 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-text-muted text-sm">&#x23EF;</button>
        <button @click="tvKey('forward')" class="w-10 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-text-muted text-sm">&#x23ED;</button>
        <div class="w-4"></div>
        <button @click="tvVolume('mute')" class="w-10 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-text-muted text-sm">&#x1F507;</button>
        <button @click="tvVolume('down')" class="w-10 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-text-muted text-sm">&#x1F509;</button>
        <button @click="tvVolume('up')" class="w-10 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center text-text-muted text-sm">&#x1F50A;</button>
      </div>
      <!-- Bottom row: Back, Power, Home -->
      <div class="flex gap-2 justify-center">
        <button @click="tvKey('back')" class="flex-1 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center gap-1 text-text-muted text-xs">
          &#x2190; Back
        </button>
        <button @click="tvPower()" class="flex-1 h-10 rounded-lg bg-surface-light hover:bg-red-900/30 flex items-center justify-center gap-1 text-text-muted text-xs">
          &#x23FB; Power
        </button>
        <button @click="tvKey('home')" class="flex-1 h-10 rounded-lg bg-surface-light hover:bg-accent/20 flex items-center justify-center gap-1 text-text-muted text-xs">
          &#x1F3E0; Home
        </button>
      </div>
      <!-- Pairing overlay -->
      <div x-show="!tvConnected" class="absolute inset-0 bg-surface-dark/95 z-10 flex flex-col items-center justify-center gap-3 p-4">
        <div class="text-3xl">&#x1F4FA;</div>
        <template x-if="!tvPairing">
          <div class="text-center">
            <div class="text-sm text-text-muted mb-3" x-text="tvNeedsPairing ? 'TV needs to be paired' : 'TV not connected'"></div>
            <button @click="tvStartPairing()" class="bg-accent hover:bg-accent-light text-surface-dark px-6 py-2 rounded-lg text-sm font-medium">
              Pair with TV
            </button>
          </div>
        </template>
        <template x-if="tvPairing">
          <div class="text-center space-y-3">
            <div class="text-sm text-text-muted">Enter the PIN shown on your TV</div>
            <input x-model="tvPairPin" type="text" maxlength="6" placeholder="PIN"
                   class="w-32 bg-surface-light rounded-lg px-4 py-2 text-xl text-text font-mono text-center outline-none focus:ring-2 focus:ring-accent tracking-widest">
            <div class="flex gap-2 justify-center">
              <button @click="tvPairing = false" class="bg-surface-light text-text-muted px-4 py-2 rounded-lg text-sm">Cancel</button>
              <button @click="tvFinishPairing()" class="bg-accent hover:bg-accent-light text-surface-dark px-4 py-2 rounded-lg text-sm font-medium">Connect</button>
            </div>
          </div>
        </template>
      </div>
      <!-- Connection status -->
      <div class="text-center text-[10px]" :class="tvConnected ? 'text-green-400' : 'text-text-dim'"
           x-text="tvConnected ? 'Connected to TV' : ''"></div>
    </div>

    <!-- Timers Tab -->
    <div x-show="tab === 'timers'"
         :class="swipeDirection === 'left' ? 'tab-slide-enter-left' : swipeDirection === 'right' ? 'tab-slide-enter-right' : ''"
         class="h-full flex flex-col p-3 gap-2">
      <!-- Tab toggle: Timer / Alarm -->
      <div class="flex gap-1 self-center bg-surface rounded-lg p-0.5">
        <button @click="timerMode = 'timer'" class="px-4 py-1 rounded text-xs font-medium transition-colors"
                :class="timerMode === 'timer' ? 'bg-accent text-surface-dark' : 'text-text-muted'">Timer</button>
        <button @click="timerMode = 'alarm'" class="px-4 py-1 rounded text-xs font-medium transition-colors"
                :class="timerMode === 'alarm' ? 'bg-accent text-surface-dark' : 'text-text-muted'">Alarm</button>
      </div>

      <!-- Timer Creation -->
      <div x-show="timerMode === 'timer'" class="space-y-2">
        <!-- Quick presets -->
        <div class="flex gap-1.5 justify-center">
          <template x-for="p in [{s:30,l:'30s'},{s:60,l:'1m'},{s:180,l:'3m'},{s:300,l:'5m'},{s:600,l:'10m'},{s:900,l:'15m'},{s:1800,l:'30m'},{s:3600,l:'1h'}]" :key="p.s">
            <button @click="newTimerSec = p.s; createTimerRaw()"
                    class="w-11 h-11 rounded-full bg-surface-light hover:bg-accent/20 text-xs font-medium text-text-muted hover:text-accent transition-colors"
                    x-text="p.l"></button>
          </template>
        </div>
        <!-- Custom timer -->
        <div class="flex gap-2 items-center">
          <input x-model.number="newTimerMin" type="number" min="0" max="999" placeholder="0" @focus="$event.target.select()"
                 class="w-14 bg-surface-light rounded-lg px-2 py-1.5 text-sm text-text outline-none text-center focus:ring-1 focus:ring-accent">
          <span class="text-xs text-text-dim">min</span>
          <input x-model.number="newTimerSec" type="number" min="0" max="59" placeholder="0" @focus="$event.target.select()"
                 class="w-14 bg-surface-light rounded-lg px-2 py-1.5 text-sm text-text outline-none text-center focus:ring-1 focus:ring-accent">
          <span class="text-xs text-text-dim">sec</span>
          <input x-model="newTimerLabel" type="text" placeholder="Label"
                 class="flex-1 bg-surface-light rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:ring-1 focus:ring-accent">
          <button @click="createTimer()" class="bg-accent text-surface-dark px-4 py-1.5 rounded-lg text-sm font-medium">Start</button>
        </div>
      </div>

      <!-- Alarm Creation -->
      <div x-show="timerMode === 'alarm'" class="space-y-2">
        <div class="flex gap-2 items-center justify-center">
          <div class="flex items-center bg-surface-light rounded-lg px-2 py-1.5 gap-1">
            <input x-model.number="alarmHour" type="number" min="1" max="12" @focus="$event.target.select()"
                   class="w-10 bg-surface rounded px-1 py-1 text-lg text-text font-mono outline-none text-center">
            <span class="text-lg text-text-muted font-mono">:</span>
            <input x-model.number="alarmMin" type="number" min="0" max="59" @focus="$event.target.select()"
                   class="w-10 bg-surface rounded px-1 py-1 text-lg text-text font-mono outline-none text-center">
            <div class="flex flex-col ml-1 gap-0.5">
              <button @click="alarmAmPm = 'AM'" type="button" class="px-1.5 py-0 rounded text-xs font-medium leading-tight"
                      :class="alarmAmPm === 'AM' ? 'bg-accent text-surface-dark' : 'text-text-dim'">AM</button>
              <button @click="alarmAmPm = 'PM'" type="button" class="px-1.5 py-0 rounded text-xs font-medium leading-tight"
                      :class="alarmAmPm === 'PM' ? 'bg-accent text-surface-dark' : 'text-text-dim'">PM</button>
            </div>
          </div>
          <input x-model="alarmLabel" type="text" placeholder="Label (optional)"
                 class="flex-1 bg-surface-light rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:ring-1 focus:ring-accent">
          <button @click="createAlarmFromTime()" class="bg-accent text-surface-dark px-4 py-1.5 rounded-lg text-sm font-medium">Set</button>
        </div>
        <!-- Schedule button -->
        <div class="flex items-center justify-center">
          <button @click="schedHour = 0; schedMin = 0; schedAmPm = 'AM'; schedLabel = ''; schedDate = ''; schedRepeat = 'none'; schedRepeatDays = []; showAlarmSchedule = true" type="button"
                  class="flex items-center gap-1.5 px-3 py-1 rounded-lg text-xs font-medium bg-surface-light text-text-muted hover:text-accent hover:bg-accent/10 transition-colors">
            <span>&#128197;</span>
            <span>Schedule</span>
          </button>
        </div>
      </div>

      <!-- Active Timers & Alarms -->
      <div class="flex-1 overflow-y-auto space-y-1.5 mt-1">
        <template x-for="(item, i) in timerItems" :key="item.id">
          <div class="bg-surface-light rounded-xl px-4 py-2.5 flex items-center gap-3">
            <!-- Icon -->
            <div class="text-xl" x-text="item.type === 'timer' ? '\u23F1' : '\u23F0'"></div>
            <!-- Info -->
            <div class="flex-1 min-w-0">
              <div class="text-xs text-text-muted truncate" x-text="item.label"></div>
              <div class="text-2xl font-mono leading-tight"
                   :class="item.remaining <= 10 ? 'text-red-400 animate-pulse' : item.remaining <= 60 ? 'text-amber-400' : 'text-accent'"
                   x-text="formatCountdown(item.remaining)"></div>
            </div>
            <!-- Target time, date & repeat for alarms -->
            <div x-show="item.target_time" class="text-right shrink-0">
              <div class="text-xs text-text-dim" x-text="item.target_time"></div>
              <div x-show="item.target_date" class="text-[10px] text-text-muted" x-text="item.target_date"></div>
              <div x-show="item.repeat && item.repeat !== 'none'" class="text-[10px] text-accent" x-text="alarmRepeatLabel(item)"></div>
            </div>
            <!-- Actions -->
            <div class="flex gap-1.5 shrink-0">
              <button x-show="item.type === 'timer'" @click="pauseTimer(item.id)"
                      class="text-xs px-2.5 py-1 rounded-lg transition-colors"
                      :class="item.paused ? 'bg-accent/20 text-accent' : 'bg-surface text-text-muted'"
                      x-text="item.paused ? '&#9654;' : '&#10074;&#10074;'"></button>
              <button x-show="item.type === 'alarm' && item.fired" @click="snoozeAlarm(item.id)"
                      class="text-xs bg-accent text-surface-dark px-2.5 py-1 rounded-lg">+5m</button>
              <button @click="cancelTimer(item)"
                      class="text-xs bg-red-900/30 text-red-400 hover:bg-red-900/50 px-2.5 py-1 rounded-lg transition-colors">&times;</button>
            </div>
          </div>
        </template>
        <div x-show="timerItems.length === 0" class="flex flex-col items-center justify-center py-10 text-text-dim">
          <div class="text-3xl mb-2" x-text="timerMode === 'timer' ? '\u23F1' : '\u23F0'"></div>
          <div class="text-sm" x-text="timerMode === 'timer' ? 'No active timers' : 'No alarms set'"></div>
          <div class="text-xs mt-1 text-text-dim" x-text="timerMode === 'timer' ? 'Tap a preset or set a custom time' : 'Pick a time above'"></div>
        </div>
      </div>
    </div>

  </main>

  <!-- Now-Playing Mini Bar (global, shown on non-music tabs when music is playing) -->
  <div x-show="musicState.song && tab !== 'music'" x-transition
       class="h-9 shrink-0 bg-surface border-t border-surface-light flex items-center gap-2 px-2 z-10">
    <img :src="musicState.song?.thumbnail" class="w-7 h-7 rounded object-cover" x-show="musicState.song?.thumbnail">
    <div class="flex-1 min-w-0 cursor-pointer" @click="tab = 'music'">
      <div class="text-[11px] font-medium truncate" x-text="musicState.song?.title"></div>
      <div class="text-[9px] text-text-muted truncate" x-text="musicState.song?.artist"></div>
    </div>
    <button @click="musicCmd('previous')" class="w-6 h-6 flex items-center justify-center text-text-muted">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
        <rect x="3" y="5" width="3" height="14" rx="0.5"/><polygon points="21 5 9 12 21 19"/>
      </svg>
    </button>
    <button @click="musicCmd('pause')" class="w-7 h-7 flex items-center justify-center rounded-full bg-accent text-surface-dark">
      <template x-if="musicState.is_playing">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
          <rect x="5" y="3" width="5" height="18" rx="1"/><rect x="14" y="3" width="5" height="18" rx="1"/>
        </svg>
      </template>
      <template x-if="!musicState.is_playing">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 21 12 6 21"/></svg>
      </template>
    </button>
    <button @click="musicCmd('next')" class="w-6 h-6 flex items-center justify-center text-text-muted">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
        <polygon points="3 5 15 12 3 19"/><rect x="18" y="5" width="3" height="14" rx="0.5"/>
      </svg>
    </button>
  </div>

  <!-- Bottom Tab Bar -->
  <nav class="h-[40px] shrink-0 bg-surface border-t border-surface-light flex overflow-x-auto z-10 relative">
    <template x-for="t in tabs" :key="t.id">
      <button @click="tab = t.id" class="flex-1 min-w-[65px] flex flex-col items-center justify-center text-xs gap-0.5 transition-colors"
              :class="tab === t.id ? 'text-accent' : 'text-text-dim'">
        <span class="text-base" x-text="t.icon"></span>
      </button>
    </template>
  </nav>

  <!-- Notification Banner -->
  <div x-show="notification && !alertFired" x-transition
       class="fixed top-0 left-0 right-0 bg-accent text-surface-dark px-4 py-2 text-sm text-center z-50 cursor-pointer"
       @click="notification = null" x-text="notification">
  </div>

  <!-- Camera Overlay (accessed from chat) -->
  <div x-cloak x-show="showCameraOverlay" x-transition style="display:none"
       class="fixed inset-0 bg-surface-dark z-40 flex flex-col">
    <div class="flex-1 bg-black flex items-center justify-center relative overflow-hidden min-h-0">
      <img src="/api/camera/stream" class="w-full h-full object-cover" x-show="cameraActive" @error="cameraActive=false">
      <div x-show="!cameraActive" class="text-text-muted">Camera offline</div>
      <div x-show="visionResult" class="absolute bottom-0 left-0 right-0 bg-surface-dark/80 p-2 text-xs" x-text="visionResult"></div>
    </div>
    <div class="flex gap-2 p-2 justify-center border-t border-surface-light shrink-0">
      <button @click="cameraSnap()" class="bg-surface-light hover:bg-accent/20 px-4 py-2 rounded-lg text-sm">Snap</button>
      <button @click="cameraDescribe()" class="bg-surface-light hover:bg-accent/20 px-4 py-2 rounded-lg text-sm">Describe</button>
      <button @click="toggleMotion()" class="px-4 py-2 rounded-lg text-sm"
              :class="motionEnabled ? 'bg-accent text-surface-dark' : 'bg-surface-light'">Motion</button>
      <button @click="showCameraOverlay = false; visionResult = ''" class="bg-accent hover:bg-accent-light text-surface-dark px-4 py-2 rounded-lg text-sm font-medium">Back to Chat</button>
    </div>
  </div>

  <!-- Alarm Schedule Overlay -->
  <div x-cloak x-show="showAlarmSchedule" x-transition style="display:none"
       class="fixed inset-0 bg-surface-dark z-40 flex flex-col"
       x-effect="if (showAlarmSchedule) initAlarmCal()">
    <!-- Header -->
    <div class="h-10 shrink-0 flex items-center justify-between px-4 border-b border-surface-light">
      <button @click="showAlarmSchedule = false" class="text-text-muted hover:text-text text-sm">Cancel</button>
      <span class="text-sm font-medium text-accent">Schedule Alarm</span>
      <button @click="showAlarmSchedule = false; createScheduledAlarm()" class="text-accent hover:text-accent-light text-sm font-medium">Set</button>
    </div>

    <!-- Content — two-column layout for 800x480 -->
    <div class="flex-1 flex min-h-0">

      <!-- Left: Calendar -->
      <div class="w-1/2 border-r border-surface-light p-3 flex flex-col gap-2 overflow-y-auto">
        <div class="flex items-center justify-between">
          <button @click="alarmCalPrev()" type="button" class="w-7 h-7 rounded-full bg-surface-light text-text-muted hover:text-accent flex items-center justify-center text-sm">&lt;</button>
          <span class="text-xs font-medium text-text" x-text="alarmCalTitle()"></span>
          <button @click="alarmCalNext()" type="button" class="w-7 h-7 rounded-full bg-surface-light text-text-muted hover:text-accent flex items-center justify-center text-sm">&gt;</button>
        </div>
        <!-- Day headers -->
        <div class="grid grid-cols-7 gap-0.5 text-center">
          <template x-for="h in ['S','M','T','W','T','F','S']" :key="h">
            <div class="text-[10px] text-text-dim py-0.5" x-text="h"></div>
          </template>
        </div>
        <!-- Day grid -->
        <div class="grid grid-cols-7 gap-0.5">
          <template x-for="cell in alarmCalCells()" :key="cell.key">
            <button @click="cell.day ? pickAlarmDate(cell.iso) : null" type="button"
                    class="h-8 rounded text-xs font-medium flex items-center justify-center transition-colors"
                    :class="cell.day
                      ? (schedDate === cell.iso
                        ? 'bg-accent text-surface-dark'
                        : cell.today
                          ? 'bg-accent/20 text-accent'
                          : cell.past
                            ? 'text-text-dim/40'
                            : 'text-text-muted hover:bg-surface-light')
                      : ''"
                    x-text="cell.day || ''"></button>
          </template>
        </div>
        <!-- Quick picks -->
        <div class="flex gap-1 mt-auto">
          <button @click="pickAlarmDate(todayISO())" type="button" class="flex-1 py-1.5 rounded text-[10px] font-medium text-center transition-colors"
                  :class="schedDate === todayISO() ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'">Today</button>
          <button @click="pickAlarmDate(tomorrowISO())" type="button" class="flex-1 py-1.5 rounded text-[10px] font-medium text-center transition-colors"
                  :class="schedDate === tomorrowISO() ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'">Tomorrow</button>
        </div>
      </div>

      <!-- Right: Time, Label, Repeat + Summary -->
      <div class="w-1/2 p-3 flex flex-col gap-3 overflow-y-auto">
        <!-- Time -->
        <div class="flex items-center justify-center gap-1">
          <input x-model.number="schedHour" type="number" min="1" max="12" @focus="$event.target.select()"
                 class="w-9 bg-surface-light rounded px-1 py-1 text-lg text-text font-mono outline-none text-center">
          <span class="text-lg text-text-muted font-mono">:</span>
          <input x-model.number="schedMin" type="number" min="0" max="59" @focus="$event.target.select()"
                 class="w-9 bg-surface-light rounded px-1 py-1 text-lg text-text font-mono outline-none text-center">
          <div class="flex flex-col ml-1 gap-0.5">
            <button @click="schedAmPm = 'AM'" type="button" class="px-1.5 py-0 rounded text-[10px] font-medium leading-tight"
                    :class="schedAmPm === 'AM' ? 'bg-accent text-surface-dark' : 'text-text-dim'">AM</button>
            <button @click="schedAmPm = 'PM'" type="button" class="px-1.5 py-0 rounded text-[10px] font-medium leading-tight"
                    :class="schedAmPm === 'PM' ? 'bg-accent text-surface-dark' : 'text-text-dim'">PM</button>
          </div>
        </div>
        <!-- Label -->
        <input x-model="schedLabel" type="text" placeholder="Label (optional)"
               class="w-full bg-surface-light rounded-lg px-3 py-1.5 text-xs text-text outline-none focus:ring-1 focus:ring-accent">
        <!-- Repeat -->
        <div class="space-y-1.5">
          <div class="text-[10px] font-medium text-text-muted uppercase tracking-wider">Repeat</div>
          <div class="grid grid-cols-2 gap-1">
            <template x-for="opt in [{v:'none',l:'Once'},{v:'daily',l:'Daily'},{v:'weekdays',l:'Weekdays'},{v:'weekends',l:'Weekends'}]" :key="opt.v">
              <button @click="schedRepeat = opt.v" type="button"
                      class="py-2 rounded-lg text-xs font-medium text-center transition-colors"
                      :class="schedRepeat === opt.v ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'"
                      x-text="opt.l"></button>
            </template>
          </div>
          <button @click="schedRepeat = 'custom'" type="button"
                  class="w-full py-2 rounded-lg text-xs font-medium text-center transition-colors"
                  :class="schedRepeat === 'custom' ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted'">Custom Days</button>
        </div>

        <!-- Custom Days -->
        <div x-show="schedRepeat === 'custom'" x-transition class="space-y-1.5">
          <div class="flex gap-1 justify-center">
            <template x-for="d in [{v:'SU',l:'S'},{v:'MO',l:'M'},{v:'TU',l:'T'},{v:'WE',l:'W'},{v:'TH',l:'T'},{v:'FR',l:'F'},{v:'SA',l:'S'}]" :key="d.v">
              <button @click="toggleAlarmDay(d.v)" type="button"
                      class="w-9 h-9 rounded-full text-xs font-medium transition-colors flex items-center justify-center"
                      :class="schedRepeatDays.includes(d.v) ? 'bg-accent text-surface-dark' : 'bg-surface-light text-text-muted hover:bg-accent/20'"
                      x-text="d.l"></button>
            </template>
          </div>
          <div x-show="schedRepeatDays.length > 0" class="text-center text-[10px] text-text-dim"
               x-text="schedRepeatDays.map(d => ({SU:'Sun',MO:'Mon',TU:'Tue',WE:'Wed',TH:'Thu',FR:'Fri',SA:'Sat'}[d])).join(', ')"></div>
        </div>

        <!-- Summary -->
        <div class="bg-surface rounded-xl p-2.5 text-center mt-auto">
          <div class="text-[10px] text-text-dim mb-0.5">Alarm fires</div>
          <div class="text-xs text-accent font-medium" x-text="alarmScheduleDescription()"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Timer/Alarm Alert Overlay -->
  <div x-cloak x-show="alertFired" x-transition
       class="fixed inset-0 bg-surface-dark/95 z-50 flex flex-col items-center justify-center gap-6">
    <div class="text-5xl" x-text="alertFired?.type === 'alarm' ? '\u23F0' : '\u23F1'"></div>
    <div class="text-2xl font-medium text-accent animate-pulse" x-text="alertFired?.label"></div>
    <div class="text-sm text-text-muted">Time's up!</div>
    <div class="flex flex-wrap gap-2 justify-center mt-2">
      <template x-for="p in [{s:30,l:'30s'},{s:60,l:'1m'},{s:180,l:'3m'},{s:300,l:'5m'},{s:600,l:'10m'},{s:900,l:'15m'},{s:1800,l:'30m'},{s:3600,l:'1h'}]" :key="p.s">
        <button @click="snoozeAlert(p.s)"
                class="w-12 h-12 rounded-full bg-surface-light text-text text-xs font-medium hover:bg-accent/20 hover:text-accent transition-colors"
                x-text="'+' + p.l"></button>
      </template>
    </div>
    <button @click="dismissAlert()"
            class="px-8 py-3 rounded-xl bg-accent text-surface-dark text-sm font-medium hover:bg-accent-light transition-colors mt-2">
      Dismiss
    </button>
  </div>

  <script src="/static/js/bmo.js"></script>
</body>
</html>
